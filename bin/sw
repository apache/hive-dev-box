#!/bin/bash -e

#[ "$EUID" != 0 ] && sudo $0 "$@" && exit 0


SW_DIR=${SW_DIR:-/work/}
SW_DL_DIR=${SW_DL_DIR:-$SW_DIR/.downloads}

mkdir -p $SW_DIR $SW_DL_DIR

apache_mirror='http://xenia.sote.hu/ftp/mirrors/www.apache.org/'
archive_mirror='https://archive.apache.org/dist/'

err_report() {
    echo "Error on line $1"
}

trap 'err_report $LINENO' ERR

function dl() {

	[ -f "$1" ] && echo "already downloaded $1" && return 0
	f=$1
	shift
	while [ "$1" != "" ];do
		wget -nv -O "$f.tmp" "$1" && mv "$f.tmp" "$f" && return 0
		shift
	done
	echo "unable to download $f"
	return 1
}

function activate() {
	echo "@ activating: $2 for $1"
	T=/active/$1
	rm -f "$T"
	ln -s "$2" "$T"

}


cd $SW_DIR
component="${1}"
shift
case "$component" in
	hive-dev)
		d=/home/dev/hive/packaging/target/apache-hive-*-SNAPSHOT-bin/apache-hive-*-SNAPSHOT-bin/
		[ ! -d $d ] && echo "ERROR: expected a directory at: $d" && exit 1
		activate hive $d
	;;
	hive|hadoop|tez)
		sw2 $component "$@"
	;;
	eclipse)
		bin_dir=$SW_DIR/eclipse
		if [ -d "$bin_dir" ];then
			echo "$bin_dir already installed"
		else
			fn=$SW_DL_DIR/eclipse.tar.gz
			dl $fn \
				http://eclipse.mirror.garr.it/mirrors/eclipse//technology/epp/downloads/release/2019-09/R/eclipse-jee-2019-09-R-linux-gtk-x86_64.tar.gz
			tar xzf $fn
			wget -nv https://github.com/seeq12/eclipse-import-projects-plugin/raw/master/jar/com.seeq.eclipse.importprojects_1.4.0.jar \
				-O eclipse/plugins/com.seeq.eclipse.importprojects_1.4.0.jar
			sed 's/-Xmx1024m/-Xmx3024m/' eclipse/eclipse.ini
			#rm $fn
		fi
		activate $component $bin_dir
	;;
	visualvm)
		version=${1:-1.4.4}
		v1=${version//./}
		bin_dir=$SW_DIR/visualvm_$v1
		if [ -d "$bin_dir" ];then
			echo "$bin_dir already installed"
		else
			fn=$SW_DL_DIR/visualvm-${version}.zip
			dl $fn \
				https://github.com/visualvm/visualvm.src/releases/download/${version}/visualvm_${v1}.zip
			unzip $fn
		fi
		activate $component $bin_dir
	;;
	maven)
		version=${1:-3.6.1}
		bin_dir=$SW_DIR/apache-maven-$version
		if [ -d "$bin_dir" ];then
			echo "$bin_dir already installed"
		else
			fn=$SW_DL_DIR/apache-maven-${version}.tar.gz
			dl $fn \
				${apache_mirror}/maven/maven-3/${version}/binaries/apache-maven-${version}-bin.tar.gz
			tar xzf $fn
			#rm $fn
		fi
		activate $component $bin_dir
	;;
	protobuf)
		version=${1:-2.5.0}
		bin_dir=/work/protobuf-${version}
		if [ -d "$bin_dir" ];then
			echo "$bin_dir already installed"
		else
			sudo apt-get install -y autoconf automake libtool curl make g++ unzip
			fn=$SW_DL_DIR/protobuf-${version}.zip
			dl $fn \
				https://github.com/google/protobuf/releases/download/v${version}/protobuf-${version}.zip
			d="$SW_DL_DIR/protobuf-${version}.tmp"
			rm -rf $d
			mkdir $d
			cd $d
			unzip $fn
			cd protobuf-${version}
			./autogen.sh
			./configure --prefix=$bin_dir
			make
			make install
		fi
		activate $component $bin_dir
	;;
	*)
		cat << EOF
Switches between installed components
	$0 <hadoop|hive|hive-dev|tez> [version]
	example:
		$0 hive			# activates some recent hive
		$0 hive 3.1.1
		$0 hadoop
		$0 hive-dev		# switches to use /hive-dev's binary package
EOF
		exit 1
	;;
esac
