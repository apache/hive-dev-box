#!/bin/bash -e

[ "$GITHUB_USER" == "" ] && echo "GITHUB_USER must be set to have this work" && exit 1

cd
git clone -o apache --reference /reference/hive https://github.com/apache/hive hive
cd hive
git remote add $GITHUB_USER git@github.com:$GITHUB_USER/hive

git fetch --all

branch=$1
if [ "$branch" == "" ];then
    branch="`hostname`"
fi

case $branch in
    master|branch-*)
            git branch $branch apache/$branch
        ;;
    HIVE-*)
            if [ -e .git/refs/remotes/$GITHUB_USER/$branch ] ;then
                git branch $branch $GITHUB_USER/$branch
            else
                git branch $branch
                git push $GITHUB_USER -u HEAD
            fi
        ;;
    *)
            echo "not sure...expected HIVE- prefix or master/branch-x; $branch looks out of place"
        ;;
esac

git checkout $branch
modules=${HIVE_DEFAULT_MODULES:-ql,common}

git config --local extra.ideProjects $modules
git config --local extra.mavenOpts "-Denforcer.skip -Phadoop-2,itests -DskipSparkTests"
#FIXME install thrift/protobuf/etc
#git config --local extra.mavenOpts "-Denforcer.skip -Phadoop-2,itests -Ditest.jdbc.jars=/home/kirk/projects/hive/jdbc/ojdbc6.jar -Dthrift.home=/home/kirk/tools/thrift/thrift-0.9.3 -DskipSparkTests -Dprotoc.path=/home/kirk/tools/protobuf-2.5.0/protobuf-2.5.0/src/protoc"

/usr/local/hive-toolbox/scripts/xl_hive_reinit $modules

cd ..

WS=ws_$branch
mkdir $WS
cd $WS
tar xzf /hive-dev-box/tools/def_ws.tgz
cd ..

sudo dd of=/bin/dev_eclipse << EOF
#!/bin/bash -e
/active/eclipse/eclipse -nosplash -data ~/$WS "\$@"
EOF
sudo chmod +x /bin/dev_eclipse

eclipse -nosplash -data ~/$WS -application com.seeq.eclipse.importprojects.headlessimport -import ~/hive


banner ok
echo "run dev_eclipse to open eclipse"